#setwd('C:/Users/syjan/Desktop/internship/research-CRC')
library(tidyverse)
library(readxl)
#library(sas7bdat) #read sas file -> 느림
library(haven) #이게 더 빠르다
library(stringr)


#(1) 환자정보데이터
patient_info = read_xlsx('DATA_na_removed.xlsx')
head(patient_info)
colnames(patient_info)
View(patient_info)
dim(patient_info) #540, 200

#(2) 식이데이터 변수명
ffq_protocol = read_xlsx('ffq_protocol.xlsx', sheet=1) %>%
  select(1:5) %>% rename('content' = '...5') 
View(ffq_protocol)

#(3) 환자 식이데이터
ffq = read_sas('FFQ540.sas7bdat')
head(ffq)
View(ffq)
dim(ffq) #362340, 103


#(4) 변수명 예쁘게 저장하기
ffq_protocol = ffq_protocol %>%
  mutate(var_name = str_to_lower(content),
         var_name = str_replae(var_name,"\\([^()]+\\)", ''),
         var_name = str_replace_all(var_name, ' ', '_'),
         var_name = str_replace(var_name, 'β', 'beta'),
         var_name = str_replace(var_name, "_$", "")) 
ffq_protocol$var_name[62:63] = c('clupanodonic_acid', 'osbond_acid')
View(ffq_protocol)

colnames(ffq)[8:103] = ffq_protocol$var_name[7:102]
View(ffq)


#(5) 106가지 식품 -> 35가지 식품군으로 재분류하기 (code from Tung)
#food_group: group index, food_group_name: group name

#food group
ffq = ffq %>% 
  mutate(food_group = case_when(
    foodc %in% c(11003010,11011010,11018010,12001000,12006000) ~ 1,
    foodc %in% c(11014020,11014050,11014080,11015000,11018030,11025000,11028000,11029000,12002000,12003000,12003010,12005000,12005010) ~ 2,
    foodc %in% c(21001000,21001020,23001000,24001000,51004000) ~ 3,
    foodc %in% c(13001000,13007000,13013010,13023010,13026030,24007000) ~4,
    foodc %in% c(17003000,17004000,17004010,17005000,17006010,17006020,17006030,17007010,17007020,17009000,17010010,17010020,17011000,17012000,17013000,17013010) ~ 5,
    foodc %in% c(14001000,14004000,14006010,14017000,14022000,14023000,14027020) ~ 6,
    foodc %in% c(11023020,11023100,11023130,11023160,16007020,16007190,16007200,16008000,16009010,16012000,16012020,16012030,16012240,16012260) ~7,
    foodc %in% c(15007020,96002010) ~ 8,
    foodc %in% c(15002000,15004040,15004060,15004080,15004150,15004160,16013010,16013040,16013050,31002000,31005020,32003040,32003060,32003090,32006010,32009010,33002040) ~ 9,
    foodc %in% c(41008000,42001010,42002000) ~ 10,
    foodc %in% c(43001000,43003000,43004000,43005000,43006000,43009000) ~ 11,
    foodc %in% c(51005010,51005050,51015020,51017010,52001020,52003010,52004020)~12,
    foodc %in% c(91014000,91025000,91026000,91029000,92001000,92002000,92003000,92004000,92005000,92006000,92007000,92008000,92009000,92012010,92018010,94001010)~13,
    foodc %in% c(91036000,92016020)~14,
    foodc %in% c(95003010,95005000,95005020,95006010,95006020,95006040,95006050,95006060,95007010,95007020,95007060,95007080)~15,
    foodc %in% c(93001000,93001010,93001020,93001030,93001060,93001070,93002000,93003000,93003030,93005000,93005010,93005120,93007000)~16,
    foodc %in% c(111005000,111007000,111011000,111021000,111024000,111030000,111042000,111044180,111060000,111061010,111061020,111061030,111062000,111062010,111062020,
                 111062040,111062130,111062140,111102000,111140020,111140030,111140070,111149000,111156150)~17,
    foodc %in% c(116001000,116008010,116008030,116009000)~18,
    foodc %in% c(112010020,112010030,112012010,112015010,112018000,112020010,112021000,112025000,112025010,112044000,112045000,112056020,112057010,113003000,113009000,113019030,113019040,
                 113021000,113024000,113026000,113026010,113028000,113028010,113035010,114004010,114004020,114008000,114008020)~19,
    foodc %in% c(111061040,111061050,111062080,111062110,111074020,111149010,111149020,111156160,111174020,112010090,112045030,113013030,113027030,114002020,114008070,114008080,114008120)~20,
    foodc %in% c(121003010,121003060,121005010,121010010,121010020,121010030,121010060)~21,
    foodc %in% c(101001000,102001000)~22,
    foodc %in% c(131002000,131003010,131003040,131003050)~23,
    foodc %in% c(133002070,133002090,133002100,133002110,133002120,133003000,133003020,133004000,133005000,134001000,135001000,135002000,135002010,136002000,136004000)~24,
    foodc %in% c(81001020,81001030,81001040,81003020,81003050,81007020,81014000,81017000,81018010,81018030,81020010,81020020,81020030,81023030,81023050,81023060,81028000,81035000,81039000,81041000,81048050,81048060,81048080)~25,
    foodc %in% c(81007040,81020070,81020080,81023090,81023150,81025030,81035020,81035050,81048120,81048150)~26,
    foodc %in% c(61008020,61009010,61010010,61011000,61011020,61013010,61013020,61013030,61013060,61014010,61015010,61021000,61028000,
                 61035000,61035010,61036010,61046000,61047000,61056000,61062000,61062020,61074000,61076000,61083010,61083020,61091000,
                 61091020,61096000,61097000,61099000,61103000,61135000,61139010,61142000,61143000,61144000,61148000,61149000,61149020,
                 61149030,61149040,61149060,61150000,61151010,61151020,61151030,61155010,61155020,61155030,61155060,61155080,61156000)~27,
    foodc %in% c(61037010,61037020,61038000,61052010,61059090,61059150,61059160,61070000,61070020,61084000,61086000,61089000,61089010,61107000,61107010,61107020,61108000,61113000,61118010,61123000,61146000,63002000)~28,
    foodc %in% c(61013040,61046020,61052040,61052090,61059030,61059080,61118040)~29,
    foodc %in% c(62001000,62002000,62003000,62004000,62005000,62007000,62008000,62009000,62012000,62013000)~30,
    foodc %in% c(71002000,71004020,71009000,71012000,71015000,71016000,71016070) ~31,
    foodc %in% c(141003000,141005000,142004000,142012000,142013000,142015000)~32,
    foodc %in% c(161001010,161001040,161002010,161004010,161005000,161006000,161009030,161016010,161018000,161030010,161031010,161036030,161041000,171005000,171009010)~33,
    foodc %in% c(151003000,151003040,151003050,151003060,151003070,151005000,151006000)~34,
    foodc %in% c(151001000,151008020,152005020,152010000,152014000,152016000)~35,
    foodc %in% c(153009000,153005000,153005010,153011020,153015020,153015030,153003000,153013000)~36,
    TRUE ~ NA_real_
  ))

#food group name 저장
food_group_names <- tribble(
  ~food_group, ~food_group_name,
  1, "Refined grains",
  2, "Whole grains",
  3, "Tubers and roots",
  4, "Noodles",
  5, "Rice cakes",
  6, "Bread",
  7, "Cereals and snacks",
  8, "Pizza and hamburger",
  9, "Cakes and sweets",
  10, "Legumes",
  11, "Tofu and soy milk",
  12, "Nuts and seeds",
  13, "Red meat",
  14, "Meat by-products",
  15, "Processed meat",
  16, "Poultry",
  17, "Fish",
  18, "Seafood products",
  19, "Other seafood",
  20, "Salted fermented seafood",
  21, "Seaweeds",
  22, "Eggs",
  23, "Milk",
  24, "Dairy Products",
  25, "Fruits",
  26, "Fruit products",
  27, "Green and yellow vegetables",
  28, "Light-colored vegetables",
  29, "Pickled vegetables",
  30, "Kimchi",
  31, "Mushrooms",
  32, "Oil and fat",
  33, "Condiments and seasonings",
  34, "Carbonated beverages",
  35, "Coffee and tea",
  36, "Alcohol"
)

#merge 
ffq = ffq %>% left_join(food_group_names, by='food_group') 
colSums(is.na(ffq))

#확인
ffq %>% select(contains("food")) %>% distinct() %>% View()

#(6) 필요한 column만 추출, 변수명 변경해 저장, 영양소 데이터 제거
ffq = ffq %>% 
  arrange(CAN_ID) %>%
  rename('food_type_code' = 'way',
         'food_name_code' =  'foodc',
         'weight' = 'wet',
         'food_name' = 'foodn',
         'food_type' = 'food') 
ffq_sm = ffq %>% select('CAN_ID':'energy', contains('food'), -'foodg') 
View(ffq_sm)
colnames(ffq_sm)
colSums(is.na(ffq_sm)) #0
dim(ffq_sm) #362340,9


#(7)환자정보+식이정보 full data 생성 후 저장
full_dat = patient_info %>% inner_join(ffq, by='CAN_ID') %>%
  arrange(CAN_ID)
dim(full_dat) #204149, 304
head(full_dat)
colnames(full_dat) 

write_csv(ffq_protocol, 'ffq_protocol.csv')
write_csv(ffq,'ffq.csv')
write_csv(ffq_sm, 'ffq_sm.csv')
write_csv(full_dat,'full_dat.csv')
